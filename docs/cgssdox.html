CGSS Shift Management Project Documentation
==========================================

Project Overview
---------------
The CGSS Shift Management project, developed for CGSS Bank, addresses the challenges of manual shift scheduling by providing a robust, cloud-native web application. The system streamlines employee scheduling, absence management, and notifications, replacing inefficient Excel-based methods. Built using Flask, Docker, Kubernetes, and Google Cloud Platform (GCP), the application supports role-based access, secure authentication, and scalable deployment. This documentation outlines the major tasks, technical implementations, and practical steps taken to deliver a secure, user-friendly, and maintainable solution.

Student: Amine Souissi
Academic Supervisor: Mrs. Swvar Ekimi
Enterprise Supervisor: Mr. Attila Pohorai
Duration: Six months (2024-2025)

Task 1: Develop Flask-based Web Application
-----------------------------------------
Description:
Built a Flask web application to handle user authentication, employee management, and shift scheduling with distinct roles for admins (full control) and employees (view-only access to shifts and personal details).

How I Did It:
- Initialized a Flask project with modular blueprints for user, employee, and shift management.
- Used Flask-Login for session management and role-based access control.
- Created SQLite database with tables for users, employees, and shifts.
- Deployed locally using `flask run`.

Code Example:
```
# app.py
from flask import Flask
from flask_login import LoginManager
from models import db, User

app = Flask(__name__)
app.config['SQLALCHEMY_DATABASE_URI'] = 'sqlite:///site.db'
app.config['SECRET_KEY'] = 'your-secret-key'
db.init_app(app)
login_manager = LoginManager(app)

@app.route('/')
def index():
    return render_template('index.html')

# Blueprint registration
from routes.users import users_bp
app.register_blueprint(users_bp)
```

Command:
```
flask run
```
Access: http://localhost:5000

Task 2: Implement Secure Password Encryption
-------------------------------------------
Description:
Replaced Werkzeugâ€™s password hashing with Fernet encryption for secure password storage and verification.

How I Did It:
- Installed `cryptography` package: `pip install cryptography`.
- Generated a Fernet key and used it to encrypt/decrypt passwords.
- Updated user model to store encrypted passwords.
- Modified login logic to decrypt and verify passwords.

Code Example:
```
# models.py
from cryptography.fernet import Fernet
from flask_sqlalchemy import SQLAlchemy

db = SQLAlchemy()
key = Fernet.generate_key()
fernet = Fernet(key)

class User(db.Model):
    id = db.Column(db.Integer, primary_key=True)
    username = db.Column(db.String(80), unique=True)
    password = db.Column(db.String(255))

    def set_password(self, password):
        self.password = fernet.encrypt(password.encode()).decode()

    def check_password(self, password):
        try:
            return fernet.decrypt(self.password.encode()).decode() == password
        except:
            return False
```

Command:
```
python -c "from cryptography.fernet import Fernet; print(Fernet.generate_key().decode())"
```

Task 3: Fix User-Employee Relationship in Database
-------------------------------------------------
Description:
Corrected the user-employee relationship in the SQLite database to ensure proper shift assignment.

How I Did It:
- Inspected database using SQLite CLI: `sqlite3 site.db`.
- Updated `users` table to link `employee_id`.
- Verified with SQL query and tested login functionality.

Code Example:
```
-- SQL Commands
UPDATE users SET employee_id = 103 WHERE username = 'amine2';
SELECT id, username, employee_id FROM users WHERE username = 'amine2';
```

Command:
```
sqlite3 site.db
```

Task 4: Deploy Application on Google Cloud Platform (GCP)
--------------------------------------------------------
Description:
Deployed the Flask app on a GCP VM with a public IP for external access.

How I Did It:
- Created a GCP VM (2 vCPU, 4 GB RAM).
- Installed Python, Flask, and dependencies.
- Configured Flask to listen on `0.0.0.0:5000`.
- Opened port 5000 in GCP firewall.

Code Example:
```
# run.py
from app import app
app.run(host='0.0.0.0', port=5000)
```

Command:
```
gcloud compute firewall-rules create allow-flask --allow tcp:5000
```
Access: http://34.16.33.223:5000

Task 5: Implement Excel/CSV File Upload and Editing
-------------------------------------------------
Description:
Added functionality to upload, edit, and export Excel/CSV files for shift data.

How I Did It:
- Created an `excel` Blueprint in Flask.
- Used pandas to parse uploaded files.
- Rendered editable HTML tables with `contenteditable`.
- Added download button for modified CSV.

Code Example:
```
# routes/excel.py
from flask import Blueprint, render_template, request
import pandas as pd

excel_bp = Blueprint('excel', __name__)

@excel_bp.route('/excel', methods=['GET', 'POST'])
def excel_upload():
    if request.method == 'POST':
        file = request.files['file']
        df = pd.read_csv(file)
        return render_template('excel.html', table=df.to_html(classes='editable'))
    return render_template('excel.html')
```
```
<!-- templates/excel.html -->
<table class="editable">
    {{ table | safe }}
</table>
<button onclick="downloadCSV()">Download Edited CSV</button>
<script>
function downloadCSV() {
    // JavaScript to convert table to CSV
}
</script>
```

Task 6: Enhance Shift Management UI
----------------------------------
Description:
Improved the shift management UI with radio buttons, editable dropdowns, and AJAX updates.

How I Did It:
- Replaced dropdown with radio buttons in `shifts.html`.
- Moved "Add Shift" to bottom of interface.
- Hid time columns with CSS.
- Used AJAX for shift updates.

Code Example:
```
<!-- templates/shifts.html -->
<input type="radio" name="shift" value="Morning"> Morning
<input type="radio" name="shift" value="Evening"> Evening
<style>
    .time-column { display: none; }
</style>
<select onchange="updateShift(this)">
    {% for shift in all_shifts %}
        <option value="{{ shift.id }}">{{ shift.name }}</option>
    {% endfor %}
</select>
<script>
function updateShift(select) {
    $.post('/update_shift', { shift_id: select.value });
}
</script>
```

Task 7: Display Employee Off Days
--------------------------------
Description:
Added a route to display approved and remaining off days for employees.

How I Did It:
- Added `/off_days` route in `employees.py`.
- Created `get_approved_off_days` in service layer.
- Rendered data in `off_days.html`.
- Updated sidebar navigation.

Code Example:
```
# routes/employees.py
@employees_bp.route('/off_days')
def off_days():
    off_days_data = employee_shift_service.get_approved_off_days()
    return render_template('off_days.html', off_days=off_days_data)
```
```
<!-- templates/off_days.html -->
<table>
    {% for employee in off_days %}
        <tr>
            <td>{{ employee.name }}</td>
            <td>{{ employee.approved_off_days }}</td>
            <td>{{ employee.remaining_off_days }}</td>
        </tr>
    {% endfor %}
</table>
```

Task 8: Dockerize the Flask Application
--------------------------------------
Description:
Containerized the Flask app for consistent deployment.

How I Did It:
- Created a `Dockerfile`.
- Built and pushed image to Docker Hub.
- Ran container locally for testing.

Code Example:
```
# Dockerfile
FROM python:3.9-slim
WORKDIR /app
COPY requirements.txt .
RUN pip install -r requirements.txt
COPY . .
EXPOSE 5000
CMD ["python", "run.py"]
```

Commands:
```
docker build -t my-flask-app .
docker tag my-flask-app gocho123/my-flask-app:latest
docker push gocho123/my-flask-app:latest
docker run -p 5000:5000 gocho123/my-flask-app:latest
```

Task 9: Automate Docker Builds with GitHub Actions
------------------------------------------------
Description:
Set up a GitHub Actions workflow to automate Docker builds and pushes.

How I Did It:
- Added Docker Hub credentials to GitHub Secrets.
- Created a workflow YAML file.
- Tested automated build and push.

Code Example:
```
# .github/workflows/docker-build.yml
name: Docker Build
on: [push]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}
      - name: Build and push
        uses: docker/build-push-action@v3
        with:
          context: .
          push: true
          tags: gocho123/my-flask-app:latest
```

Task 10: Deploy Flask App on GCP with Terraform
----------------------------------------------
Description:
Used Terraform to deploy the Flask app on a GCP VM with Docker.

How I Did It:
- Wrote `main.tf` to provision VM and install Docker.
- Configured firewall rules for port 5000.
- Applied Terraform script and tested access.

Code Example:
```
# main.tf
provider "google" {
  project = "your-project-id"
}
resource "google_compute_instance" "flask_vm" {
  name         = "flask-vm"
  machine_type = "e2-medium"
  boot_disk {
    initialize_params {
      image = "debian-cloud/debian-10"
    }
  }
  network_interface {
    network = "default"
    access_config {}
  }
  metadata_startup_script = "apt-get update && apt-get install -y docker.io && docker run -p 5000:5000 gocho123/my-flask-app:latest"
}
```

Commands:
```
terraform init
terraform apply
```
Access: http://34.135.178.175:5000/login

Task 11: Deploy Apache Guacamole on VM
-------------------------------------
Description:
Deployed Apache Guacamole for remote desktop access using Docker Compose.

How I Did It:
- Created a `docker-compose.yml` for Guacamole services.
- Installed Docker and Docker Compose on a Debian VM.
- Ran the stack and accessed Guacamole.

Code Example:
```
# docker-compose.yml
version: '3'
services:
  guacd:
    image: guacamole/guacd
  guac-mysql:
    image: mysql:8.0
    environment:
      MYSQL_ROOT_PASSWORD: rootpass
  guacamole:
    image: guacamole/guacamole
    ports:
      - "8080:8080"
    depends_on:
      - guacd
      - guac-mysql
```

Command:
```
docker-compose up -d
```
Access: http://<VM_IP>/guacamole

Task 12: Set Up Authentication Server with HashiCorp Vault
--------------------------------------------------------
Description:
Configured HashiCorp Vault for secure credential management.

How I Did It:
- Installed Vault on a VM: `sudo apt install vault`.
- Initialized and unsealed Vault.
- Enabled SSH secrets engine.

Code Example:
```
# Vault commands
vault operator init
vault operator unseal
vault secrets enable ssh
```

Task 13: Configure NGINX Reverse Proxy
-------------------------------------
Description:
Set up NGINX as a reverse proxy for the Flask app.

How I Did It:
- Created NGINX config in `/etc/nginx/sites-available/cggsdox`.
- Tested and reloaded NGINX.

Code Example:
```
# cggsdox
server {
    listen 8080;
    location /cggsdox/ {
        proxy_pass http://localhost:5000/;
    }
}
```

Commands:
```
sudo nginx -t
sudo systemctl reload nginx
```
Access: http://35.208.94.224:8080/cggsdox/

Task 14: Set Up Kubernetes Cluster
---------------------------------
Description:
Established a Kubernetes cluster with master and worker nodes.

How I Did It:
- Created VMs using `qemu-img` and `virt-install`.
- Installed Kubernetes components.
- Initialized cluster and deployed Flannel.

Code Example:
```
# On master node
kubeadm init
kubectl apply -f https://raw.githubusercontent.com/coreos/flannel/master/Documentation/kube-flannel.yml
```

Task 15: Expose Flask App via NGINX Reverse Proxy on Kubernetes
-------------------------------------------------------------
Description:
Configured NGINX and SSH tunneling for Kubernetes-hosted Flask app.

How I Did It:
- Set up SSH tunnel to forward traffic.
- Configured NGINX to proxy to Kubernetes service.
- Updated DNS for subdomain.

Code Example:
```
# SSH Tunnel
ssh -L 8888:cggs-master:30532 user@poha-webserver
```

Access: http://amine.attilapohorai.com/my_shifts/

Task 16: Deploy TeamCity on Kubernetes
-------------------------------------
Description:
Deployed TeamCity for CI/CD on Kubernetes.

How I Did It:
- Created `teamcity-deployment.yaml`.
- Applied deployment and set up SSH tunnel.
- Resolved pod crashes by clearing disk space.

Code Example:
```
# teamcity-deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: teamcity
spec:
  replicas: 1
  selector:
    matchLabels:
      app: teamcity
  template:
    metadata:
      labels:
        app: teamcity
    spec:
      containers:
      - name: teamcity
        image: jetbrains/teamcity-server
        ports:
        - containerPort: 8111
---
apiVersion: v1
kind: Service
metadata:
  name: teamcity-service
spec:
  type: NodePort
  ports:
  - port: 8111
    nodePort: 30111
  selector:
    app: teamcity
```

Command:
```
kubectl apply -f teamcity-deployment.yaml
```

Task 17: Configure TeamCity CI/CD Pipeline
-----------------------------------------
Description:
Set up TeamCity to automate Flask app builds and deployments.

How I Did It:
- Connected TeamCity to GitHub repo with a token.
- Configured build steps for dependencies and app execution.

Code Example:
```
# Build Steps in TeamCity
1. pip install -r requirements.txt
2. python run.py
```

Access: http://192.168.122.76:5000

Task 18: Automate SSH Tunnel with Systemd
----------------------------------------
Description:
Automated SSH tunneling using a systemd service.

How I Did It:
- Created `autossh-tunnel.service`.
- Enabled service to start on boot.

Code Example:
```
# /etc/systemd/system/autossh-tunnel.service
[Unit]
Description=AutoSSH Tunnel
After=network.target
[Service]
ExecStart=/usr/bin/autossh -M 0 -L 31111:cggs-master:30532 user@poha-webserver
Restart=always
[Install]
WantedBy=multi-user.target
```

Commands:
```
sudo systemctl enable autossh-tunnel
sudo systemctl start autossh-tunnel
```

Task 19: Implement Blue/Green Deployment with Ansible
---------------------------------------------------
Description:
Used Ansible for blue/green deployment to minimize downtime.

How I Did It:
- Created `deploy_flask_docker.yml` playbook.
- Configured green deployment, health checks, and traffic switch.

Code Example:
```
# deploy_flask_docker.yml
- hosts: flask_servers
  tasks:
    - name: Run green container
      docker_container:
        name: flask-green
        image: gocho123/my-flask-app:latest
        ports: "5001:5000"
    - name: Health check
      uri:
        url: http://localhost:5001/health
    - name: Switch NGINX to green
      copy:
        content: |
          server { listen 80; location / { proxy_pass http://localhost:5001; } }
        dest: /etc/nginx/sites-available/default
    - name: Remove blue container
      docker_container:
        name: flask-blue
        state: absent
```

Command:
```
ansible-playbook deploy_flask_docker.yml
```
Access: http://34.59.9.209/login

Conclusion
----------
The CGSS Shift Management project successfully delivered a scalable, secure, and user-friendly web application that modernized shift scheduling at CGSS Bank. By leveraging Flask, Docker, Kubernetes, GCP, and modern DevOps practices, the system addressed key pain points, improved operational efficiency, and enhanced employee satisfaction. The modular architecture and automated CI/CD pipelines ensure maintainability and future scalability.
